<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PrimeMar - A modern social media platform">
    <meta name="theme-color" content="#3b82f6">
    <title>PrimeMar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Previous CSS remains the same, adding new styles below */

        /* Enhanced Post Actions */
        .post-action.active {
            color: var(--primary-color);
        }

        .post-action.like-action.active {
            color: var(--error-color);
        }

        .post-action.retweet-action.active {
            color: var(--success-color);
        }

        /* Share Modal */
        .share-options {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 16px;
            justify-content: center;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .share-option:hover {
            background: var(--hover-color);
            transform: translateY(-2px);
        }

        .share-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--primary-light);
            color: var(--primary-color);
        }

        /* Alert/Notification Styles */
        .alert-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Message Button in Profile */
        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .message-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .message-btn:hover {
            background: var(--primary-hover);
        }

        .alert-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .alert-btn:hover {
            background: var(--hover-color);
        }

        .alert-btn.active {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }

        /* Enhanced Search Results */
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .search-result-item:hover {
            background: var(--hover-color);
        }

        .search-result-info {
            flex: 1;
        }

        /* Loading States */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- All previous HTML remains the same until the profile section -->

    <!-- Profile Page -->
    <section id="profilePage" class="page">
        <div class="profile-header">
            <img src="" alt="Profile" class="profile-avatar" id="profileAvatar">
            <button class="action-btn" id="editProfileBtn" style="position: absolute; bottom: 10px; right: 20px; background: rgba(255,255,255,0.8);">
                <i class="fas fa-edit"></i>
            </button>
        </div>
        <div class="profile-info">
            <h3 id="profileName">User Name</h3>
            <p class="user-handle" id="profileHandle">@username</p>
            <p class="profile-bio" id="profileBio">This is a sample bio. Update your profile to add your own bio!</p>
            
            <div class="profile-stats">
                <div style="cursor: pointer;" id="postsCountContainer">
                    <strong id="postsCount">0</strong>
                    <div>Posts</div>
                </div>
                <div style="cursor: pointer;" id="followingCountContainer">
                    <strong id="followingCount">0</strong>
                    <div>Following</div>
                </div>
                <div style="cursor: pointer;" id="followersCountContainer">
                    <strong id="followersCount">0</strong>
                    <div>Followers</div>
                </div>
            </div>
            
            <div class="profile-actions">
                <button class="follow-btn" id="followBtn">Follow</button>
                <button class="message-btn" id="messageUserBtn">
                    <i class="fas fa-envelope"></i> Message
                </button>
                <button class="alert-btn" id="alertBtn">
                    <i class="fas fa-bell"></i> Alert
                </button>
                <button class="profile-share-btn" id="shareProfileBtn">
                    <i class="fas fa-share-alt"></i> Share
                </button>
            </div>
        </div>
        
        <div id="profilePostsContainer">
            <!-- User's posts will be loaded here -->
        </div>
    </section>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Share Post</div>
                <button class="modal-close" id="closeShareModal">&times;</button>
            </div>
            <div class="share-options">
                <div class="share-option" data-action="copy">
                    <div class="share-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <span>Copy Link</span>
                </div>
                <div class="share-option" data-action="twitter">
                    <div class="share-icon" style="background: rgba(29, 161, 242, 0.1); color: #1da1f2;">
                        <i class="fab fa-twitter"></i>
                    </div>
                    <span>Twitter</span>
                </div>
                <div class="share-option" data-action="facebook">
                    <div class="share-icon" style="background: rgba(24, 119, 242, 0.1); color: #1877f2;">
                        <i class="fab fa-facebook"></i>
                    </div>
                    <span>Facebook</span>
                </div>
                <div class="share-option" data-action="whatsapp">
                    <div class="share-icon" style="background: rgba(37, 211, 102, 0.1); color: #25d366;">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <span>WhatsApp</span>
                </div>
                <div class="share-option" data-action="message">
                    <div class="share-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <span>Message</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PrimeMar {
            constructor() {
                // Previous properties remain the same
                this.likedPosts = new Set();
                this.retweetedPosts = new Set();
                this.userAlerts = new Set();
                this.activePostForShare = null;
            }

            async init() {
                // Previous init code remains the same
                await this.loadUserLikesAndRetweets();
            }

            async loadUserLikesAndRetweets() {
                if (!this.currentUser) return;

                // Load user's liked posts
                const { data: likes } = await this.supabase
                    .from('likes')
                    .select('post_id')
                    .eq('user_id', this.currentUser.id);

                if (likes) {
                    likes.forEach(like => this.likedPosts.add(like.post_id));
                }

                // Load user's retweeted posts
                const { data: retweets } = await this.supabase
                    .from('retweets')
                    .select('post_id')
                    .eq('user_id', this.currentUser.id);

                if (retweets) {
                    retweets.forEach(retweet => this.retweetedPosts.add(retweet.post_id));
                }

                // Load user alerts
                const { data: alerts } = await this.supabase
                    .from('alerts')
                    .select('user_id')
                    .eq('follower_id', this.currentUser.id);

                if (alerts) {
                    alerts.forEach(alert => this.userAlerts.add(alert.user_id));
                }
            }

            setupEventListeners() {
                // Previous event listeners remain the same

                // New event listeners for enhanced features
                
                // Share modal
                document.getElementById('closeShareModal').addEventListener('click', () => {
                    document.getElementById('shareModal').classList.remove('active');
                });

                // Share options
                document.querySelectorAll('.share-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const action = e.currentTarget.dataset.action;
                        this.handleShareAction(action);
                    });
                });

                // Alert button
                document.getElementById('alertBtn').addEventListener('click', () => {
                    this.toggleUserAlert();
                });
            }

            async likePost(postId) {
                try {
                    const isLiked = this.likedPosts.has(postId);
                    
                    if (isLiked) {
                        // Unlike post
                        await this.supabase
                            .from('likes')
                            .delete()
                            .eq('user_id', this.currentUser.id)
                            .eq('post_id', postId);
                        
                        this.likedPosts.delete(postId);
                        this.showToast('Post unliked');
                    } else {
                        // Like post
                        await this.supabase
                            .from('likes')
                            .insert({
                                user_id: this.currentUser.id,
                                post_id: postId
                            });
                        
                        this.likedPosts.add(postId);
                        this.showToast('Post liked');

                        // Send notification to post author
                        const { data: post } = await this.supabase
                            .from('posts')
                            .select('author_id, profiles(name)')
                            .eq('id', postId)
                            .single();

                        if (post && post.author_id !== this.currentUser.id) {
                            await this.supabase
                                .from('notifications')
                                .insert({
                                    user_id: post.author_id,
                                    type: 'like',
                                    source_user_id: this.currentUser.id,
                                    message: `${this.userProfile.name} liked your post`,
                                    post_id: postId
                                });
                        }
                    }

                    await this.loadFeed();
                    
                } catch (error) {
                    console.error('Error liking post:', error);
                    this.showError('Failed to like post');
                }
            }

            async retweetPost(postId) {
                try {
                    const isRetweeted = this.retweetedPosts.has(postId);
                    
                    if (isRetweeted) {
                        // Remove retweet
                        await this.supabase
                            .from('retweets')
                            .delete()
                            .eq('user_id', this.currentUser.id)
                            .eq('post_id', postId);
                        
                        this.retweetedPosts.delete(postId);
                        this.showToast('Retweet removed');
                    } else {
                        // Retweet post
                        await this.supabase
                            .from('retweets')
                            .insert({
                                user_id: this.currentUser.id,
                                post_id: postId
                            });
                        
                        this.retweetedPosts.add(postId);
                        this.showToast('Post retweeted');

                        // Send notification to post author
                        const { data: post } = await this.supabase
                            .from('posts')
                            .select('author_id, profiles(name)')
                            .eq('id', postId)
                            .single();

                        if (post && post.author_id !== this.currentUser.id) {
                            await this.supabase
                                .from('notifications')
                                .insert({
                                    user_id: post.author_id,
                                    type: 'retweet',
                                    source_user_id: this.currentUser.id,
                                    message: `${this.userProfile.name} retweeted your post`,
                                    post_id: postId
                                });
                        }
                    }

                    await this.loadFeed();
                    
                } catch (error) {
                    console.error('Error retweeting post:', error);
                    this.showError('Failed to retweet post');
                }
            }

            async sharePost(postId) {
                this.activePostForShare = postId;
                document.getElementById('shareModal').classList.add('active');
            }

            async handleShareAction(action) {
                if (!this.activePostForShare) return;

                const postUrl = `${window.location.origin}?post=${this.activePostForShare}`;
                const postText = 'Check out this post on PrimeMar!';

                try {
                    switch (action) {
                        case 'copy':
                            await this.copyToClipboard(postUrl);
                            this.showToast('Link copied to clipboard');
                            break;
                            
                        case 'twitter':
                            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(postText)}&url=${encodeURIComponent(postUrl)}`, '_blank');
                            break;
                            
                        case 'facebook':
                            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(postUrl)}`, '_blank');
                            break;
                            
                        case 'whatsapp':
                            window.open(`https://wa.me/?text=${encodeURIComponent(postText + ' ' + postUrl)}`, '_blank');
                            break;
                            
                        case 'message':
                            // This would open the messaging interface
                            this.showToast('Share via message - feature coming soon!');
                            break;
                    }

                    // Record share in database
                    await this.supabase
                        .from('shares')
                        .insert({
                            user_id: this.currentUser.id,
                            post_id: this.activePostForShare,
                            platform: action
                        });

                    document.getElementById('shareModal').classList.remove('active');
                    this.activePostForShare = null;
                    
                } catch (error) {
                    console.error('Error sharing post:', error);
                    this.showError('Failed to share post');
                }
            }

            async toggleUserAlert() {
                if (!this.userProfile || this.userProfile.id === this.currentUser.id) return;

                const userId = this.userProfile.id;
                const isAlerting = this.userAlerts.has(userId);
                
                try {
                    if (isAlerting) {
                        // Remove alert
                        await this.supabase
                            .from('alerts')
                            .delete()
                            .eq('follower_id', this.currentUser.id)
                            .eq('user_id', userId);
                        
                        this.userAlerts.delete(userId);
                        document.getElementById('alertBtn').classList.remove('active');
                        this.showToast('Alerts turned off for this user');
                    } else {
                        // Add alert
                        await this.supabase
                            .from('alerts')
                            .insert({
                                follower_id: this.currentUser.id,
                                user_id: userId
                            });
                        
                        this.userAlerts.add(userId);
                        document.getElementById('alertBtn').classList.add('active');
                        this.showToast('You will receive alerts for this user');
                    }
                    
                } catch (error) {
                    console.error('Error toggling user alert:', error);
                    this.showError('Failed to update alerts');
                }
            }

            updateAlertButton() {
                if (!this.userProfile || this.userProfile.id === this.currentUser.id) {
                    document.getElementById('alertBtn').style.display = 'none';
                    return;
                }

                const isAlerting = this.userAlerts.has(this.userProfile.id);
                document.getElementById('alertBtn').classList.toggle('active', isAlerting);
                document.getElementById('alertBtn').innerHTML = `
                    <i class="fas fa-bell${isAlerting ? '-slash' : ''}"></i> 
                    ${isAlerting ? 'Unalert' : 'Alert'}
                `;
            }

            async searchUsers(query) {
                if (query.length < 2) {
                    document.getElementById('peopleContainer').innerHTML = '';
                    return;
                }

                try {
                    const { data: users, error } = await this.supabase
                        .from('profiles')
                        .select('*')
                        .or(`username.ilike.%${query}%,name.ilike.%${query}%`)
                        .limit(10);

                    if (error) throw error;

                    if (users && users.length > 0) {
                        const usersHTML = await Promise.all(users.map(async (user) => {
                            const isFollowing = await this.checkIfFollowing(user.id);
                            const isAlerting = this.userAlerts.has(user.id);
                            
                            return `
                                <div class="search-result-item" data-user-id="${user.id}">
                                    <img src="${user.avatar}" alt="${user.name}" class="avatar">
                                    <div class="search-result-info">
                                        <div class="user-name">${user.name}</div>
                                        <div class="user-handle">@${user.username}</div>
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button class="follow-btn ${isFollowing ? 'following' : ''}" 
                                                data-user-id="${user.id}"
                                                onclick="primeMarApp.handleSearchFollow('${user.id}')">
                                            ${isFollowing ? 'Following' : 'Follow'}
                                        </button>
                                        <button class="message-btn" 
                                                onclick="primeMarApp.handleSearchMessage('${user.id}')">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                        <button class="alert-btn ${isAlerting ? 'active' : ''}" 
                                                data-user-id="${user.id}"
                                                onclick="primeMarApp.handleSearchAlert('${user.id}')">
                                            <i class="fas fa-bell${isAlerting ? '-slash' : ''}"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }));

                        document.getElementById('peopleContainer').innerHTML = usersHTML.join('');
                    } else {
                        document.getElementById('peopleContainer').innerHTML = 
                            '<div class="p-3 text-center">No users found</div>';
                    }
                    
                } catch (error) {
                    console.error('Error searching users:', error);
                    document.getElementById('peopleContainer').innerHTML = 
                        '<div class="p-3 text-center">Error searching users</div>';
                }
            }

            async checkIfFollowing(userId) {
                if (userId === this.currentUser.id) return false;
                
                const { data } = await this.supabase
                    .from('follows')
                    .select('id')
                    .eq('follower_id', this.currentUser.id)
                    .eq('following_id', userId)
                    .single();
                
                return !!data;
            }

            async handleSearchFollow(userId) {
                const isFollowing = await this.checkIfFollowing(userId);
                
                if (isFollowing) {
                    await this.unfollowUser(userId);
                } else {
                    await this.followUser(userId);
                }
                
                // Refresh search results
                const currentQuery = document.getElementById('searchInput').value;
                if (currentQuery) {
                    await this.searchUsers(currentQuery);
                }
            }

            async handleSearchMessage(userId) {
                const { data: user } = await this.supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (user) {
                    await this.loadChat(user);
                    this.showPage('messagesPage');
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    document.querySelector('[data-page="messagesPage"]').classList.add('active');
                }
            }

            async handleSearchAlert(userId) {
                const isAlerting = this.userAlerts.has(userId);
                
                if (isAlerting) {
                    await this.supabase
                        .from('alerts')
                        .delete()
                        .eq('follower_id', this.currentUser.id)
                        .eq('user_id', userId);
                    
                    this.userAlerts.delete(userId);
                } else {
                    await this.supabase
                        .from('alerts')
                        .insert({
                            follower_id: this.currentUser.id,
                            user_id: userId
                        });
                    
                    this.userAlerts.add(userId);
                }
                
                // Refresh search results
                const currentQuery = document.getElementById('searchInput').value;
                if (currentQuery) {
                    await this.searchUsers(currentQuery);
                }
            }

            renderPosts(posts, prepend = false) {
                const feedContainer = document.getElementById('feedContainer');
                const postsHTML = posts.map(post => {
                    const isLiked = this.likedPosts.has(post.id);
                    const isRetweeted = this.retweetedPosts.has(post.id);
                    const isOwnPost = post.author_id === this.currentUser.id;

                    return `
                        <div class="post" data-post-id="${post.id}">
                            <div style="display: flex; gap: 12px;">
                                <img src="${post.profiles.avatar}" alt="${post.profiles.name}" class="avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(post.profiles.name)}&background=3b82f6&color=fff&size=128'">
                                <div style="flex: 1;">
                                    <div class="post-header">
                                        <span class="user-name">${post.profiles.name}</span>
                                        <span class="user-handle">@${post.profiles.username}</span>
                                        <span>Â·</span>
                                        <span class="post-time">${this.formatTime(post.created_at)}</span>
                                    </div>
                                    <div class="post-content">${this.formatPostContent(post.content)}</div>
                                    <div class="post-actions">
                                        <button class="post-action comment-action">
                                            <i class="far fa-comment"></i>
                                            <span>${post.comments_count || 0}</span>
                                        </button>
                                        <button class="post-action retweet-action ${isRetweeted ? 'active' : ''}" 
                                                onclick="primeMarApp.retweetPost('${post.id}')">
                                            <i class="fas fa-retweet"></i>
                                            <span>${post.retweets_count || 0}</span>
                                        </button>
                                        <button class="post-action like-action ${isLiked ? 'active' : ''}" 
                                                onclick="primeMarApp.likePost('${post.id}')">
                                            <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                                            <span>${post.likes_count || 0}</span>
                                        </button>
                                        <button class="post-action" onclick="primeMarApp.sharePost('${post.id}')">
                                            <i class="far fa-share-square"></i>
                                        </button>
                                        ${!isOwnPost ? `
                                        <button class="post-action" onclick="primeMarApp.followUserFromPost('${post.author_id}')">
                                            <i class="fas fa-user-plus"></i>
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                if (prepend) {
                    feedContainer.innerHTML = postsHTML + feedContainer.innerHTML;
                } else {
                    feedContainer.innerHTML = postsHTML;
                }
            }

            async followUserFromPost(userId) {
                const isFollowing = await this.checkIfFollowing(userId);
                
                if (isFollowing) {
                    await this.unfollowUser(userId);
                } else {
                    await this.followUser(userId);
                }
                
                // Reload feed to update follow buttons
                await this.loadFeed();
            }

            async loadFeed() {
                const feedContainer = document.getElementById('feedContainer');
                feedContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading posts...</div>';

                try {
                    const { data, error } = await this.supabase
                        .from('posts')
                        .select(`
                            *,
                            profiles:author_id (name, username, avatar),
                            likes_count:likes(count),
                            retweets_count:retweets(count),
                            comments_count:comments(count)
                        `)
                        .order('created_at', { ascending: false })
                        .limit(50);

                    if (error) throw error;

                    if (data) {
                        // Process counts
                        const posts = data.map(post => ({
                            ...post,
                            likes_count: post.likes_count[0]?.count || 0,
                            retweets_count: post.retweets_count[0]?.count || 0,
                            comments_count: post.comments_count[0]?.count || 0
                        }));

                        this.posts = posts;
                        this.renderPosts(this.posts);
                    } else {
                        feedContainer.innerHTML = '<div class="p-3 text-center">No posts yet. Be the first to post!</div>';
                    }
                    
                } catch (error) {
                    console.error('Error loading feed:', error);
                    feedContainer.innerHTML = '<div class="p-3 text-center">Error loading posts</div>';
                }
            }

            async handleSearch(query) {
                if (query.length < 2) {
                    document.getElementById('peopleContainer').innerHTML = '';
                    return;
                }

                await this.searchUsers(query);
            }

            updateProfileUI() {
                if (!this.userProfile) return;
                
                // Previous updateProfileUI code remains the same
                document.getElementById('userName').textContent = this.userProfile.name;
                document.getElementById('userAvatar').src = this.userProfile.avatar;
                document.getElementById('profileName').textContent = this.userProfile.name;
                document.getElementById('profileHandle').textContent = '@' + this.userProfile.username;
                document.getElementById('profileAvatar').src = this.userProfile.avatar;
                document.getElementById('profileBio').textContent = this.userProfile.bio || 'This is a sample bio. Update your profile to add your own bio!';
                
                // Update action buttons
                this.updateFollowButton(this.userProfile.id, await this.checkIfFollowing(this.userProfile.id));
                this.updateAlertButton();

                // Get counts
                this.updateProfileCounts();
            }

            async updateProfileCounts() {
                // Get post count
                const { count: postsCount } = await this.supabase
                    .from('posts')
                    .select('id', { count: 'exact', head: true })
                    .eq('author_id', this.userProfile.id);

                // Get following count
                const { count: followingCount } = await this.supabase
                    .from('follows')
                    .select('id', { count: 'exact', head: true })
                    .eq('follower_id', this.userProfile.id);

                // Get followers count
                const { count: followersCount } = await this.supabase
                    .from('follows')
                    .select('id', { count: 'exact', head: true })
                    .eq('following_id', this.userProfile.id);

                document.getElementById('postsCount').textContent = postsCount || 0;
                document.getElementById('followingCount').textContent = followingCount || 0;
                document.getElementById('followersCount').textContent = followersCount || 0;
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.primeMarApp = new PrimeMar();
        });
    </script>
</body>
</html>